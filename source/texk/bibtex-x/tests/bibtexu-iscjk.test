#! /bin/sh -vx
# $Id$
# Copyright 2022-2023 TANAKA Takuji <ttk@t-lab.opal.ne.jp>
# You may freely use, modify and/or distribute this file.

BinDir=${BinDir:-.}
ExeExt=${ExeExt:-}
_bibtexu=$BinDir/bibtexu$ExeExt

test -d tests || mkdir -p tests

for loc in C.UTF-8 C.utf8 en_US.UTF-8 en_US.utf8 ja_JP.UTF-8 ja_JP.utf8; do
  locale -a | grep "^$loc\$"
  ret=$?
  # For Slackware linux, we need to replace from utf8 to UTF-8
  if [ -f /etc/slackware-version ]; then
    loc=`echo $loc | sed -e "s/utf8/UTF-8/"`
  fi
  if [ $ret = 0 ]; then
    LC_ALL=$loc; LANGUAGE=$loc; export LC_ALL LANGUAGE
    break
  fi
done
if [ $ret != 0 ]; then
  # linux musl fails to run `locale -a` but seems to have C.UTF-8
  loc=C.UTF-8
  LC_ALL=$loc; LANGUAGE=$loc; export LC_ALL LANGUAGE
fi
#
TEXMFCNF=$srcdir/../kpathsea; export TEXMFCNF
BSTINPUTS=$srcdir/tests; export BSTINPUTS
BIBINPUTS=$srcdir/tests; export BIBINPUTS


rc=0

## test for is.knj.str$

icuver=1000
$_bibtexu --version | grep 'ICU version' | sed -E 's/.*ICU version ([1-9][0-9])\..*/\1/' > tests/icuver.txt
icuver=`cat tests/icuver.txt`
echo "*** icuver="$icuver
if [ $icuver -le 73 ]; then
  # skip CJK Ideograph Extension I
  # ex. U+2EBF0
  uchr='\x{2EBF0}'
fi
if [ $icuver -le 70 ]; then
  # skip CJK Ideograph Extension H
  # ex. U+31350
  uchr=${uchr}'|\x{31350}'
fi
if [ $icuver -le 65 ]; then
  # skip CJK Ideograph Extension G
  # ex. U+30000
  uchr=${uchr}'|\x{30000}'
fi
cp $srcdir/tests/iscjku.aux tests/xiscjku.aux
$_bibtexu tests/xiscjku || rc=1
cp $srcdir/tests/iscjku.bbl tests/oiscjku.bbl
if [ $icuver -le 73 ]; then
  echo "*** skip checking CJK Ideograph Extension G, H or I"
  perl -i".bak" -CD -ne "print unless /${uchr}/" tests/oiscjku.bbl
  perl -i".bak" -CD -ne "print unless /${uchr}/" tests/xiscjku.bbl
fi
diff tests/oiscjku.bbl tests/xiscjku.bbl || rc=2

exit $rc
