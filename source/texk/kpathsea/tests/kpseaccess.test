#! /bin/sh -vx
# $Id$
# Copyright 2017 Karl Berry <tex-live@tug.org>
# Copyright 2010 Peter Breitenlohner <tex-live@tug.org>
# You may freely use, modify and/or distribute this file.

BinDir=${BinDir:-.}
ExeExt=${ExeExt:-}
_kpseaccess=$BinDir/kpseaccess$ExeExt
_kpsewhich=$BinDir/kpsewhich$ExeExt

ret=0

pass () {
  echo "***** unexpected success of '$_kpseaccess $@'"
  ret=77
}

fail () {
  echo "***** unexpected failure of '$_kpseaccess $@'"
  ret=78
}

$_kpseaccess '' nonesuch && exit 1
$_kpseaccess - nonesuch && exit 2
$_kpseaccess r nonesuch && exit 3
$_kpseaccess w nonesuch && exit 4
$_kpseaccess x nonesuch && exit 5

$_kpseaccess '' access.o || exit 6
$_kpseaccess - access.o || exit 7
$_kpseaccess rw access.o || exit 8
# From the access(3p) POSIX manpage:
#   If the process has appropriate privileges, an implementation may indicate
#   success for X_OK even if none of the execute file permission bits are set.
$_kpseaccess x access.o && pass x access.o

# Testing write access to kpseaccess itself might fail with ETXTBSY.
$_kpseaccess rwx $_kpsewhich || {
  fail rwx kpsewhich
  $_kpseaccess r $_kpsewhich || fail r kpsewhich
  $_kpseaccess w $_kpsewhich || fail w kpsewhich
  $_kpseaccess x $_kpsewhich || fail x kpsewhich
}

$_kpseaccess r $srcdir/access.c || exit 9
$_kpseaccess x $srcdir/access.c && pass x $srcdir/access.c

if $_kpseaccess w $srcdir/access.c; then
  echo 'file "$srcdir/access.c" is writable'
else
  echo 'file "$srcdir/access.c" is not writable'
fi

exit $ret

