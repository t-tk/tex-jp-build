name: Build on mingw
run-name: ${{ github.actor }} is building and testing on mingw
on:
  push:
    branches:
      - 'build-mingw/*'
jobs:
  Build-on-mingw:
    runs-on: windows-latest
    timeout-minutes: 40
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch [ ${{ github.ref }} ]  Repository [ ${{ github.repository }} ]"
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: install tools
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-icu

      - name: make libs
        shell: msys2 {0}
        run: |
          echo "dbg000"
          pwd
          ls -l .
          echo "dbg0001"
          ls -l ./source
          echo "dbg0002"
          mkdir ./source/Work
          echo "dbg0003"
          mkdir ./source/Work/libs
          echo "dbg0004"
          mkdir ./source/Work/libs/zlib
          echo "dbg0005"
          cd ./source/Work/libs/zlib
          pwd
          echo "dbg000"
          ls -l .
          echo "dbg001"
          ls -l ..
          echo "dbg002"
          ls -l ../..
          echo "dbg003"
          ls -l ../../..
          echo "dbg004"
          # ls -l ${{ github.workspace }}/source/libs
          echo "dbg005"
          ls -l ../../..
          echo "dbg006"
          ls -l ../../../source/libs
          echo "dbg007"
          ls -l ../../../source/libs/zlib
          echo "dbg008"
          ../../../libs/zlib/configure
          make
          echo "dbg009"
          make check
          echo "dbg010"
          mkdir -p ${{ github.workspace }}/source/Work/libs/libpng
          cd ${{ github.workspace }}/source/Work/libs/libpng
          ${{ github.workspace }}/source/libs/libpng/configure
          make
          make check
          mkdir -p ${{ github.workspace }}/source/Work/libs/libpaper
          cd ${{ github.workspace }}/source/Work/libs/libpaper
          ${{ github.workspace }}/source/libs/libpaper/configure
          make
          make check

      - name: make kpathsea, ptexenc
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/kpathsea
          cd ${{ github.workspace }}/source/Work/texk/kpathsea
          ${{ github.workspace }}/source/texk/kpathsea/configure
          make
          make check
          mkdir -p ${{ github.workspace }}/source/Work/texk/ptexenc
          cd ${{ github.workspace }}/source/Work/texk/ptexenc
          ${{ github.workspace }}/source/texk/ptexenc/configure
          make

      - name: bibtex-x
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/bibtex-x
          cd ${{ github.workspace }}/source/Work/texk/bibtex-x
          ${{ github.workspace }}/source/texk/bibtex-x/configure \
            --with-system-icu
          make
          ./bibtex8 --version
          ./bibtexu --version

          export srcdir=${{ github.workspace }}/source/texk/bibtex-x
          test -d tests || mkdir tests
          TEXMFCNF=$srcdir/../kpathsea; export TEXMFCNF
          BSTINPUTS=$srcdir/tests; export BSTINPUTS
          BIBINPUTS=$srcdir/tests; export BIBINPUTS
          uchr='\360\261\215\220'
          cp $srcdir/tests/iscjku.aux tests/xiscjku.aux
          ./bibtexu tests/xiscjku
          diff --ignore-matching-lines=`printf "${uchr}"` $srcdir/tests/iscjku.bbl tests/xiscjku.bbl
          make check

      - name: upmendex
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/upmendex
          cd ${{ github.workspace }}/source/Work/texk/upmendex
          ${{ github.workspace }}/source/texk/upmendex/configure \
            --with-system-icu
          make
          ./upmendex --help
          make check

      - name: dvipdfm-x
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/dvipdfm-x
          cd ${{ github.workspace }}/source/Work/texk/dvipdfm-x
          ${{ github.workspace }}/source/texk/dvipdfm-x/configure
          make
          make check

      - name: dvipsk
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/dvipsk
          cd ${{ github.workspace }}/source/Work/texk/dvipsk
          ${{ github.workspace }}/source/texk/dvipsk/configure
          make
          make check

      - name: makejvf
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/makejvf
          cd ${{ github.workspace }}/source/Work/texk/makejvf
          ${{ github.workspace }}/source/texk/makejvf/configure
          make
          make check

      - name: mendex
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/mendexk
          cd ${{ github.workspace }}/source/Work/texk/mendexk
          ${{ github.workspace }}/source/texk/mendexk/configure
          make
          make check

      - name: dviout-util
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/dviout-util
          cd ${{ github.workspace }}/source/Work/texk/dviout-util
          ${{ github.workspace }}/source/texk/dviout-util/configure
          make
          make check

      - name: dvi2tty
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/dvi2tty
          cd ${{ github.workspace }}/source/Work/texk/dvi2tty
          ${{ github.workspace }}/source/texk/dvi2tty/configure
          make
          make check

      - name: seetex
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/seetexk
          cd ${{ github.workspace }}/source/Work/texk/seetexk
          ${{ github.workspace }}/source/texk/seetexk/configure
          make
          make check

      - name: dvidvi
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/dvidvi
          cd ${{ github.workspace }}/source/Work/texk/dvidvi
          ${{ github.workspace }}/source/texk/dvidvi/configure
          make
          make check

      - name: make libs
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/libs/{gmp,mpfr}
          cd ${{ github.workspace }}/source/Work/libs/gmp
          ${{ github.workspace }}/source/libs/gmp/configure
          make
          make check
          cd ${{ github.workspace }}/source/Work/libs/mpfr
          ${{ github.workspace }}/source/libs/mpfr/configure
          make
          make check

      - name: web2c
        shell: msys2 {0}
        run: |
          mkdir -p ${{ github.workspace }}/source/Work/texk/web2c
          cd ${{ github.workspace }}/source/Work/texk/web2c
          ${{ github.workspace }}/source/texk/web2c/configure \
            --srcdir=${{ github.workspace }}/source/texk/web2c \
            --disable-all-pkgs \
            --enable-debug \
            --enable-ptex \
            --enable-eptex \
            --enable-uptex \
            --enable-euptex \
            --enable-pmp \
            --enable-upmp \
            --enable-ptex-synctex \
            --enable-eptex-synctex \
            --enable-uptex-synctex \
            --enable-euptex-synctex \
            --disable-pdftex \
            --disable-pdftex-synctex \
            --disable-mf \
            --disable-mf-nowin \
            --disable-tex \
            --disable-tex-synctex \
            --disable-etex \
            --disable-etex-synctex \
            --disable-aleph \
            --disable-luatex \
            --disable-luajittex \
            --disable-luahbtex \
            --disable-luajithbtex \
            --disable-mp \
            --disable-xetex \
            --disable-xetex-synctex \
            --disable-mflua \
            --disable-mflua-nowin \
            --disable-mfluajit \
            --disable-mfluajit-nowin \
            --disable-epsfwin \
            --disable-hp2627win \
            --disable-mftalkwin \
            --disable-nextwin \
            --disable-regiswin \
            --disable-suntoolswin \
            --disable-tektronixwin \
            --disable-unitermwin \
            --disable-web-progs \
            --disable-synctex \
            --disable-missing \
            --with-gnu-ld \
            --without-x \
            --without-mf-x-toolkit \
            --without-system-kpathsea \
            --without-system-ptexenc \
            --without-system-zlib \
            --without-system-libpng \
            --without-system-freetype2 \
            --with-system-pixman \
            --with-system-cairo \
            --without-system-gmp \
            --without-system-mpfr \
            --without-system-poppler \
            --without-system-xpdf \
            --without-system-zziplib \
            --without-system-teckit \
            --without-system-icu \
            --without-system-graphite2 \
            --without-system-harfbuzz
          make
          make check

      - run: echo "⛄ This job's status is ${{ job.status }}."
