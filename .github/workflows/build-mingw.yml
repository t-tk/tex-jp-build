name: Build on MinGW
run-name: ${{ github.actor }} is building and testing on MinGW
on:
  push:
    branches:
      - 'build-mingw/**'
      - 'build/**'
jobs:
  Build-on-mingw:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "This job is now running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch [ ${{ github.ref }} ]  Repository [ ${{ github.repository }} ]"
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: install tools
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-icu
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gmp
            mingw-w64-x86_64-mpfr
            bison
            texinfo

      - name: make libs
        shell: msys2 {0}
        run: |
          mkdir ./source/Work
          mkdir ./source/Work/libs

          mkdir ./source/Work/libs/zlib
          cd ./source/Work/libs/zlib
          ../../../libs/zlib/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpng
          cd ./source/Work/libs/libpng
          ../../../libs/libpng/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpaper
          cd ./source/Work/libs/libpaper
          ../../../libs/libpaper/configure
          make
          make check

      - name: make kpathsea, ptexenc
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk

          mkdir ./source/Work/texk/kpathsea
          cd ./source/Work/texk/kpathsea
          ../../../texk/kpathsea/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/texk/ptexenc
          cd ./source/Work/texk/ptexenc
          ../../../texk/ptexenc/configure
          make

      - name: upmendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/upmendex
          cd ./source/Work/texk/upmendex
          ../../../texk/upmendex/configure \
            --with-system-icu
          make
          ./upmendex --help
          make check

      - name: dvipdfm-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipdfm-x
          cd ./source/Work/texk/dvipdfm-x
          ../../../texk/dvipdfm-x/configure
          make
          make check

      - name: dvipsk
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipsk
          cd ./source/Work/texk/dvipsk
          ../../../texk/dvipsk/configure
          make
          make check

      - name: makejvf
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/makejvf
          cd ./source/Work/texk/makejvf
          ../../../texk/makejvf/configure
          make
          make check

      - name: mendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/mendexk
          cd ./source/Work/texk/mendexk
          ../../../texk/mendexk/configure
          make
          make check

      - name: dviout-util
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dviout-util
          cd ./source/Work/texk/dviout-util
          ../../../texk/dviout-util/configure
          make
          make check || cat dvispc.log

      - name: dvi2tty
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvi2tty
          cd ./source/Work/texk/dvi2tty
          ../../../texk/dvi2tty/configure
          make
          make check

      - name: seetex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/seetexk
          cd ./source/Work/texk/seetexk
          ../../../texk/seetexk/configure
          make
          make check || cat seetexk.log
        env:
          ExeExt: ".exe"
          TEXMFCNF: "../../../texk/kpathsea"

      - name: dvidvi
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvidvi
          cd ./source/Work/texk/dvidvi
          ../../../texk/dvidvi/configure
          make
          make check
        env:
          TEXMFCNF: "../../../texk/kpathsea"

      - name: bibtex-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/bibtex-x
          cd ./source/Work/texk/bibtex-x
          ../../../texk/bibtex-x/configure \
            --with-system-icu
          make
          ## link without libtool
          echo -e "###\n### link without libtool\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o bibtex8.exe bibtex8-bibtex-1.o bibtex8-bibtex-2.o bibtex8-bibtex-3.o bibtex8-bibtex-4.o bibtex8-bibtex.o bibtex8-utils.o ../../texk/kpathsea/.libs/libkpathsea.a
          g++  -g -O2   -o bibtexu.exe bibtexu-bibtex-1.o bibtexu-bibtex-2.o bibtexu-bibtex-3.o bibtexu-bibtex-4.o bibtexu-bibtex.o bibtexu-utils.o ../../texk/kpathsea/.libs/libkpathsea.a -L/mingw64/lib  -licuio -licuin -licuuc -licudt -lpthread -lm
          ./bibtex8.exe --version
          ./bibtexu.exe --version
          make check
        env:
          ExeExt: ".exe"
          TEXMFCNF: "../../../texk/kpathsea"

      - name: web2c
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/web2c
          cd ./source/Work/texk/web2c
          ../../../texk/web2c/configure \
            --srcdir=../../../texk/web2c \
            --disable-all-pkgs \
            --enable-debug \
            --enable-ptex \
            --enable-eptex \
            --enable-uptex \
            --enable-euptex \
            --disable-pmp \
            --disable-upmp \
            --enable-ptex-synctex \
            --enable-eptex-synctex \
            --enable-uptex-synctex \
            --enable-euptex-synctex \
            --disable-pdftex \
            --disable-pdftex-synctex \
            --disable-mf \
            --disable-mf-nowin \
            --enable-tex \
            --enable-tex-synctex \
            --disable-etex \
            --disable-etex-synctex \
            --disable-aleph \
            --disable-luatex \
            --disable-luajittex \
            --disable-luahbtex \
            --disable-luajithbtex \
            --disable-mp \
            --disable-xetex \
            --disable-xetex-synctex \
            --disable-mflua \
            --disable-mflua-nowin \
            --disable-mfluajit \
            --disable-mfluajit-nowin \
            --disable-epsfwin \
            --disable-hp2627win \
            --disable-mftalkwin \
            --disable-nextwin \
            --disable-regiswin \
            --disable-suntoolswin \
            --disable-tektronixwin \
            --disable-unitermwin \
            --enable-web-progs \
            --disable-synctex \
            --disable-missing \
            --with-gnu-ld \
            --without-x \
            --without-mf-x-toolkit \
            --without-system-kpathsea \
            --without-system-ptexenc \
            --without-system-zlib \
            --without-system-libpng \
            --without-system-freetype2 \
            --with-system-pixman \
            --with-system-cairo \
            --with-system-gmp \
            --with-system-mpfr \
            --without-system-poppler \
            --without-system-xpdf \
            --without-system-zziplib \
            --without-system-teckit \
            --without-system-icu \
            --without-system-graphite2 \
            --without-system-harfbuzz
          make ctie.exe
          make ctwill.exe
          make ctwill-refsort.exe || echo ""
          make ctwill-twinx.exe || echo ""
          make cweave.exe
          make tie.exe
          make twill.exe || echo ""
          make updvitype.web
          make updvitype.p
          make updvitype.c
          make updvitype.exe
          make uppltotf.web
          make uppltotf.p
          make uppltotf.c
          make uppltotf.exe
          make uptftopl.web
          make uptftopl.p
          make uptftopl.c
          make uptftopl.exe
          make tex.p
          make tex.exe
          # make etex.web
          # make etex.p
          # make etex.exe
          make ptex.web
          make ptex.p
          make ptex.exe
          make uptex.web
          make uptex.p
          make uptex.exe
          make eptex.web
          make eptex.p
          make eptex.exe
          make euptex.web
          make euptex.p
          make euptex.exe
          make upbibtex.web
          make upbibtex.p
          make upbibtex.c
          make upbibtex.exe
          make dvitype.exe
          make dvicopy.exe
          make pltotf.exe
          make tftopl.exe
          make bibtex.exe
          make gftodvi.exe
          make gftopk.exe
          make gftype.exe
          make mft.exe
          make patgen.exe
          make pktogf.exe
          make pktype.exe
          make pooltype.exe
          # make pmp.web
          # make pmp.p
          # make pmp.c
          # make pmp.exe
          # make upmp.web
          # make upmp.p
          # make upmp.c
          # make upmp.exe
          # make pmpopst.exe || echo "fail to make pmpopst.exe"
          # make upmpopst.exe || echo "fail to make upmpopst.exe"
          echo "!!! make complete !!!"

      - name: web2c version check
        shell: msys2 {0}
        run: |
          cd ./source/Work/texk/web2c
          ./ctie.exe --version || echo "ctie"
          echo ""
          ./ctwill.exe --version || echo "ctwill"
          echo ""
          ./cweave.exe --version || echo "cwaeve"
          echo ""
          ./tie.exe --version || echo "tie"
          echo ""
          ./twill.exe --version || echo "twill"
          echo ""
          ./ptex.exe --version || echo "ptex"
          echo ""
          ./uptex.exe --version || echo "uptex"
          echo ""
          ./eptex.exe --version || echo "eptex"
          echo ""
          ./euptex.exe --version || echo "euptex"
          echo ""
          ./updvitype.exe --version || echo "updvitype"
          echo ""
          ./uppltotf.exe --version || echo "uppltotf"
          echo ""
          ./uptftopl.exe --version || echo "uptftopl"
          echo ""
          ./upbibtex.exe --version || echo "upbibtex"
          echo ""
          ./dvitype.exe --version || echo "dvitype"
          echo ""
          ./dvicopy.exe --version || echo "dvicopy"
          echo ""
          ./pltotf.exe --version || echo "pltotf"
          echo ""
          ./tftopl.exe --version || echo "tftopl"
          echo ""
          ./bibtex.exe --version || echo "bibtex"
          echo ""
          ./gftodvi.exe --version || echo "gftodvi"
          echo ""
          ./gftopk.exe --version || echo "gftopk"
          echo ""
          ./gftype.exe --version || echo "gftype"
          echo ""
          ./mft.exe --version || echo "mft"
          echo ""
          ./patgen.exe --version || echo "patgen"
          echo ""
          ./pktogf.exe --version || echo "pktogf"
          echo ""
          ./pktype.exe --version || echo "pktype"
          echo ""
          ./pooltype.exe --version || echo "pooltype"
        env:
          TEXMFCNF: "../../../texk/kpathsea"

      - name: web2c check
        shell: msys2 {0}
        run: |
          cd ./source/Work/texk/web2c
          $srcdir/ctiedir/ctie.test   || echo -e "**\n** failed: ctie.test\n**"
          echo ""
          $srcdir/cwebdir/ctwill.test || echo -e "**\n** failed: ctwill.test\n**"
          echo ""
          $srcdir/cwebdir/cweave.test || echo -e "**\n** failed: cweave.test\n**"
          echo ""
          $srcdir/tiedir/tie.test     || echo -e "**\n** failed: tie.test\n**"
          echo ""

          export KPSEWHICH="./kpsewhich.exe"
          $srcdir/dvicopy.test        || echo -e "**\n** failed: dvicopy.test\n**"
          echo ""
          $srcdir/dvitype.test        || echo -e "**\n** failed: dvitype.test\n**"
          echo ""

          $srcdir/gftodvi.test        || echo -e "**\n** failed: gftodvi.test\n**"
          echo ""
          $srcdir/gftopk.test         || echo -e "**\n** failed: gftopk.test\n**"
          echo ""
          $srcdir/gftype.test         || echo -e "**\n** failed: gftype.test\n**"
          echo ""
          $srcdir/mft.test            || echo -e "**\n** failed: mft.test\n**"
          echo ""
          $srcdir/patgen.test         || echo -e "**\n** failed: patgen.test\n**"
          echo ""
          $srcdir/pktogf.test         || echo -e "**\n** failed: pktogf.test\n**"
          echo ""
          $srcdir/pktype.test         || echo -e "**\n** failed: pktype.test\n**"
          echo ""
          $srcdir/pltotf.test         || echo -e "**\n** failed: pltotf.test\n**"
          echo ""
          $srcdir/pooltype.test       || echo -e "**\n** failed: pooltype.test\n**"
          echo ""
          $srcdir/tangle.test         || echo -e "**\n** failed: tangle.test\n**"
          echo ""
          $srcdir/twill.test          || echo -e "**\n** failed: twill.test\n**"
          echo ""

          $srcdir/ptexdir/pver.test     || echo -e "**\n** failed: pver.test\n**"
          echo ""
          $srcdir/eptexdir/epver.test   || echo -e "**\n** failed: epver.test\n**"
          echo ""
          $srcdir/uptexdir/upver.test   || echo -e "**\n** failed: upver.test\n**"
          echo ""
          $srcdir/uptexdir/upkcat.test  || echo -e "**\n** failed: upkcat.test\n**"
          echo ""
          $srcdir/euptexdir/eupver.test || echo -e "**\n** failed: eupver.test\n**"
          echo ""
          # $srcdir/uptexdir/sample.test  || echo -e "**\n** failed: sample.test\n**"
          # echo ""
          $srcdir/uptexdir/updvitype.test  || echo -e "**\n** failed: updvitype.test\n**"
          echo ""
          $srcdir/uptexdir/uppltotf.test  || echo -e "**\n** failed: uppltotf.test\n**"
          echo ""
          $srcdir/uptexdir/uptftopl.test  || echo -e "**\n** failed: uptftopl.test\n**"
          echo ""
          $srcdir/uptexdir/yokotate.test  || echo -e "**\n** failed: yokotate.test\n**"
          echo ""
          $srcdir/uptexdir/upbibtex.test  || echo -e "**\n** failed: upbibtex.test\n**"
          echo ""
          # $srcdir/uptexdir/upbibtex-mem.test  || echo -e "**\n** failed: upbibtex-mem.test\n**"
          # echo ""
          export abs_srcdir=../$srcdir
          $srcdir/mftraptest.test            || echo -e "**\n** failed: mftraptest.test\n**"
          echo ""
          $srcdir/triptest.test              || echo -e "**\n** failed: triptest.test\n**"
          echo ""
          $srcdir/etexdir/etriptest.test     || echo -e "**\n** failed: etriptest.test\n**"
          echo ""
          $srcdir/eptexdir/pdfprimitive.test || echo -e "**\n** failed: pdfprimitive.test\n**"
          echo ""
          $srcdir/ptexdir/ptriptest.test     || echo -e "**\n** failed: ptriptest.test\n**"
          echo ""
          $srcdir/uptexdir/ptriptest.test    || echo -e "**\n** failed: ptriptest.test\n**"
          echo ""
          $srcdir/uptexdir/ptriptest.test    || echo -e "**\n** failed: ptriptest.test\n**"
          echo ""
          $srcdir/uptexdir/uptriptest.test   || echo -e "**\n** failed: uptriptest.test\n**"
          echo ""
          $srcdir/eptexdir/eptriptest.test   || echo -e "**\n** failed: eptriptest.test\n**"
          echo ""
          $srcdir/euptexdir/euptriptest.test || echo -e "**\n** failed: euptriptest.test\n**"
          echo ""
          $srcdir/tests/tex-closeout.test    || echo -e "**\n** failed: tex-closeout.test\n**"
          echo ""
          $srcdir/tests/bibtex-auxinclude.test || echo -e "**\n** failed: bibtex-auxinclude.test\n**"
          echo ""
          $srcdir/tests/bibtex-bigauth.test  || echo -e "**\n** failed: bibtex-bigauth.test\n**"
          echo ""
          $srcdir/tests/bibtex-mem.test      || echo -e "**\n** failed: bibtex-mem.test\n**"
        env:
          srcdir: "../../../texk/web2c"
          TEXMFCNF: "../../../texk/kpathsea"

      - run: echo "⛄ This job's status is ${{ job.status }}."
