name: Build on mingw
run-name: ${{ github.actor }} is building and testing on mingw
on:
  push:
    branches:
      - 'build-mingw/**'
      - 'build/**'
jobs:
  Build-on-mingw:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch [ ${{ github.ref }} ]  Repository [ ${{ github.repository }} ]"
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: install tools
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-icu
            mingw-w64-x86_64-pkg-config
            texinfo

      - name: make libs
        shell: msys2 {0}
        run: |
          mkdir ./source/Work
          mkdir ./source/Work/libs

          mkdir ./source/Work/libs/zlib
          cd ./source/Work/libs/zlib
          ../../../libs/zlib/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpng
          cd ./source/Work/libs/libpng
          ../../../libs/libpng/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpaper
          cd ./source/Work/libs/libpaper
          ../../../libs/libpaper/configure
          make
          make check

      - name: make kpathsea, ptexenc
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk

          mkdir ./source/Work/texk/kpathsea
          cd ./source/Work/texk/kpathsea
          ../../../texk/kpathsea/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/texk/ptexenc
          cd ./source/Work/texk/ptexenc
          ../../../texk/ptexenc/configure
          make

      - name: upmendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/upmendex
          cd ./source/Work/texk/upmendex
          ../../../texk/upmendex/configure \
            --with-system-icu
          make
          ./upmendex --help
          make check

      - name: dvipdfm-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipdfm-x
          cd ./source/Work/texk/dvipdfm-x
          ../../../texk/dvipdfm-x/configure
          make
          make check

      - name: dvipsk
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipsk
          cd ./source/Work/texk/dvipsk
          ../../../texk/dvipsk/configure
          make
          make check

      - name: makejvf
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/makejvf
          cd ./source/Work/texk/makejvf
          ../../../texk/makejvf/configure
          make
          make check

      - name: mendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/mendexk
          cd ./source/Work/texk/mendexk
          ../../../texk/mendexk/configure
          make
          make check

      - name: dviout-util
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dviout-util
          cd ./source/Work/texk/dviout-util
          ../../../texk/dviout-util/configure
          make
          make check || cat dvispc.log

      - name: dvi2tty
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvi2tty
          cd ./source/Work/texk/dvi2tty
          ../../../texk/dvi2tty/configure
          make
          make check

      - name: seetex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/seetexk
          cd ./source/Work/texk/seetexk
          ../../../texk/seetexk/configure
          make
          ./dviselect.exe || echo " "
          ./dvibook.exe || echo " "
          ./dviconcat.exe || echo " "
          ./dvitodvi.exe || echo " "
          make check || cat seetexk.log
        env:
          ExeExt: ".exe"
          srcroot: "../../.."
          TEXMFCNF: "../../../texk/kpathsea/tests/windows"

      - name: dvidvi
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvidvi
          cd ./source/Work/texk/dvidvi
          ../../../texk/dvidvi/configure
          make
          ./dvidvi.exe || echo " "

          make check || cat dvidvi.log
        env:
          TEXMFCNF: "../../../texk/kpathsea"

      - name: bibtex-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/bibtex-x
          cd ./source/Work/texk/bibtex-x
          ../../../texk/bibtex-x/configure \
            --with-system-icu
          make
          ## link without libtool
          echo -e "###\n### link without libtool\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o bibtex8.exe bibtex8-bibtex-1.o bibtex8-bibtex-2.o bibtex8-bibtex-3.o bibtex8-bibtex-4.o bibtex8-bibtex.o bibtex8-utils.o ../../texk/kpathsea/.libs/libkpathsea.a
          g++  -g -O2   -o bibtexu.exe bibtexu-bibtex-1.o bibtexu-bibtex-2.o bibtexu-bibtex-3.o bibtexu-bibtex-4.o bibtexu-bibtex.o bibtexu-utils.o ../../texk/kpathsea/.libs/libkpathsea.a -L/mingw64/lib  -licuio -licuin -licuuc -licudt -lpthread -lm
          ./bibtex8.exe --version
          ./bibtexu.exe --version
          make check

      - run: echo "⛄ This job's status is ${{ job.status }}."
