name: Build on MinGW
run-name: building & testing on MinGW
on:
  push:
    branches:
      - 'build-mingw/**'
      - 'build/**'
jobs:
  Build-on-mingw:
    runs-on: windows-latest
    timeout-minutes: 90
    steps:
      - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "This job is now running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch [ ${{ github.ref }} ]  Repository [ ${{ github.repository }} ]"
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: install tools
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-icu
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-gmp
            mingw-w64-x86_64-mpfr
            bison
            texinfo

      - name: make libs
        shell: msys2 {0}
        run: |
          mkdir ./source/Work
          mkdir ./source/Work/libs

          mkdir ./source/Work/libs/zlib
          cd ./source/Work/libs/zlib
          ../../../libs/zlib/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpng
          cd ./source/Work/libs/libpng
          ../../../libs/libpng/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/libpaper
          cd ./source/Work/libs/libpaper
          ../../../libs/libpaper/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/pixman
          cd ./source/Work/libs/pixman
          ../../../libs/pixman/configure
          make
          make check

          cd ../../../..
          mkdir ./source/Work/libs/cairo
          cd ./source/Work/libs/cairo
          ../../../libs/cairo/configure
          make
          make check

      - name: make kpathsea, ptexenc
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk

          mkdir ./source/Work/texk/kpathsea
          cd ./source/Work/texk/kpathsea
          ../../../texk/kpathsea/configure
          make
          ## link without libtool
          echo -e "###\n### link without libtool  kpsewhich.exe\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o kpsewhich.exe kpsewhich.o .libs/libkpathsea.a || \
            echo -e "**\n** fail to link kpsewhich.exe"
          make check

          cd ../../../..
          mkdir ./source/Work/texk/ptexenc
          cd ./source/Work/texk/ptexenc
          ../../../texk/ptexenc/configure
          make

      - name: upmendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/upmendex
          cd ./source/Work/texk/upmendex
          ../../../texk/upmendex/configure \
            --with-system-icu
          make
          ./upmendex --help
          make check

      - name: dvipdfm-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipdfm-x
          cd ./source/Work/texk/dvipdfm-x
          ../../../texk/dvipdfm-x/configure
          make
          make check

      - name: dvipsk
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvipsk
          cd ./source/Work/texk/dvipsk
          ../../../texk/dvipsk/configure
          make
          make check

      - name: makejvf
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/makejvf
          cd ./source/Work/texk/makejvf
          ../../../texk/makejvf/configure
          make
          make check

      - name: mendex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/mendexk
          cd ./source/Work/texk/mendexk
          ../../../texk/mendexk/configure
          make
          make check

      - name: dviout-util
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dviout-util
          cd ./source/Work/texk/dviout-util
          ../../../texk/dviout-util/configure
          make
          make check

      - name: dvi2tty
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvi2tty
          cd ./source/Work/texk/dvi2tty
          ../../../texk/dvi2tty/configure
          make
          make check

      - name: seetex
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/seetexk
          cd ./source/Work/texk/seetexk
          ../../../texk/seetexk/configure
          make
          make check
        env:
          ExeExt: ".exe"
          TEXMFCNF: "../../../texk/kpathsea"

      - name: dvidvi
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/dvidvi
          cd ./source/Work/texk/dvidvi
          ../../../texk/dvidvi/configure
          make
          make check
        env:
          TEXMFCNF: "../../../texk/kpathsea"

      - name: bibtex-x
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/bibtex-x
          cd ./source/Work/texk/bibtex-x
          ../../../texk/bibtex-x/configure \
            --with-system-icu
          make
          ## link without libtool
          echo -e "###\n### link without libtool\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o bibtex8.exe bibtex8-bibtex-1.o bibtex8-bibtex-2.o bibtex8-bibtex-3.o bibtex8-bibtex-4.o bibtex8-bibtex.o bibtex8-utils.o ../../texk/kpathsea/.libs/libkpathsea.a
          g++  -g -O2   -o bibtexu.exe bibtexu-bibtex-1.o bibtexu-bibtex-2.o bibtexu-bibtex-3.o bibtexu-bibtex-4.o bibtexu-bibtex.o bibtexu-utils.o ../../texk/kpathsea/.libs/libkpathsea.a -L/mingw64/lib  -licuio -licuin -licuuc -licudt -lpthread -lm
          ./bibtex8.exe --version
          ./bibtexu.exe --version
          make check
        env:
          ExeExt: ".exe"
          TEXMFCNF: "../../../texk/kpathsea"

      - name: web2c
        shell: msys2 {0}
        run: |
          mkdir ./source/Work/texk/web2c
          cd ./source/Work/texk/web2c
          ../../../texk/web2c/configure \
            --srcdir=../../../texk/web2c \
            --disable-all-pkgs \
            --enable-debug \
            --enable-tex  --disable-tex-synctex \
            --enable-etex  --enable-etex-synctex \
            --enable-ptex  --enable-ptex-synctex \
            --enable-uptex  --enable-uptex-synctex \
            --enable-eptex  --enable-eptex-synctex \
            --enable-euptex  --enable-euptex-synctex \
            --enable-mp  --enable-pmp  --enable-upmp \
            --disable-pdftex  --disable-pdftex-synctex \
            --enable-web-progs \
            --enable-synctex \
            --disable-mf  --disable-mf-nowin \
            --disable-aleph \
            --disable-luatex  --disable-luajittex  --disable-luahbtex  --disable-luajithbtex \
            --disable-xetex  --disable-xetex-synctex \
            --disable-mflua  --disable-mflua-nowin  --disable-mfluajit  --disable-mfluajit-nowin \
            --disable-epsfwin  --disable-hp2627win  --disable-mftalkwin  --disable-nextwin \
            --disable-regiswin  --disable-suntoolswin  --disable-tektronixwin  --disable-unitermwin \
            --disable-missing \
            --with-gnu-ld \
            --without-x \
            --without-mf-x-toolkit \
            --without-system-kpathsea \
            --without-system-ptexenc \
            --without-system-zlib \
            --without-system-libpng \
            --without-system-freetype2 \
            --without-system-pixman \
            --without-system-cairo \
            --with-system-gmp \
            --with-system-mpfr \
            --without-system-poppler \
            --without-system-xpdf \
            --without-system-zziplib \
            --without-system-teckit \
            --without-system-icu \
            --without-system-graphite2 \
            --without-system-harfbuzz
          make || echo "fail to make"
          echo "!!! make complete !!!"

          ## link without libtool
          echo -e "###\n### link without libtool  ptex.exe\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o ptex.exe ptexdir/ptex-ptexextra.o ptex-ptexini.o ptex-ptex0.o ptex-ptex-pool.o libkanji.a lib/libp.a ../ptexenc/.libs/libptexenc.a lib/lib.a ../kpathsea/.libs/libkpathsea.a -lwsock32 libmd5.a ../../libs/zlib/libz.a || \
            echo -e "**\n** fail to link ptex.exe"

          echo -e "###\n### link without libtool  uptex.exe\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o uptex.exe uptexdir/uptex-uptexextra.o uptex-uptexini.o uptex-uptex0.o uptex-uptex-pool.o libukanji.a lib/libp.a ../ptexenc/.libs/libptexenc.a lib/lib.a ../kpathsea/.libs/libkpathsea.a -lwsock32 libmd5.a ../../libs/zlib/libz.a || \
            echo -e "**\n** fail to link uptex.exe"

          echo -e "###\n### link without libtool  eptex.exe\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o eptex.exe eptexdir/eptex-eptexextra.o synctexdir/eptex-synctex.o eptex-eptexini.o eptex-eptex0.o eptex-eptex-pool.o libkanji.a lib/libp.a ../ptexenc/.libs/libptexenc.a lib/lib.a ../kpathsea/.libs/libkpathsea.a -lwsock32 libmd5.a ../../libs/zlib/libz.a || \
            echo -e "**\n** fail to link eptex.exe"

          echo -e "###\n### link without libtool  euptex.exe\n###"
          gcc -Wimplicit -Wreturn-type -g -O2   -o euptex.exe euptexdir/euptex-euptexextra.o synctexdir/euptex-synctex.o euptex-euptexini.o euptex-euptex0.o euptex-euptex-pool.o libukanji.a lib/libp.a ../ptexenc/.libs/libptexenc.a lib/lib.a ../kpathsea/.libs/libkpathsea.a -lwsock32 libmd5.a ../../libs/zlib/libz.a || \
            echo -e "**\n** fail to link euptex.exe"

          make check || echo "fail to make check"
          echo "!!! make check complete !!!"

      - name: web2c version check
        shell: msys2 {0}
        run: |
          cd ./source/Work/texk/web2c
          ./ctie.exe --version || echo "ctie"
          echo ""
          ./ctwill.exe --version || echo "ctwill"
          echo ""
          ./cweave.exe --version || echo "cwaeve"
          echo ""
          ./tie.exe --version || echo "tie"
          echo ""
          ./twill.exe --version || echo "twill"
          echo ""
          ./tex.exe --version || echo "tex"
          echo ""
          ./etex.exe --version || echo "etex"
          echo ""
          ./ptex.exe --version || echo "ptex"
          echo ""
          ./uptex.exe --version || echo "uptex"
          echo ""
          ./eptex.exe --version || echo "eptex"
          echo ""
          ./euptex.exe --version || echo "euptex"
          echo ""
          ./updvitype.exe --version || echo "updvitype"
          echo ""
          ./uppltotf.exe --version || echo "uppltotf"
          echo ""
          ./uptftopl.exe --version || echo "uptftopl"
          echo ""
          ./upbibtex.exe --version || echo "upbibtex"
          echo ""
          ./dvitype.exe --version || echo "dvitype"
          echo ""
          ./dvicopy.exe --version || echo "dvicopy"
          echo ""
          ./pltotf.exe --version || echo "pltotf"
          echo ""
          ./tftopl.exe --version || echo "tftopl"
          echo ""
          ./bibtex.exe --version || echo "bibtex"
          echo ""
          ./gftodvi.exe --version || echo "gftodvi"
          echo ""
          ./gftopk.exe --version || echo "gftopk"
          echo ""
          ./gftype.exe --version || echo "gftype"
          echo ""
          ./mft.exe --version || echo "mft"
          echo ""
          ./patgen.exe --version || echo "patgen"
          echo ""
          ./pktogf.exe --version || echo "pktogf"
          echo ""
          ./pktype.exe --version || echo "pktype"
          echo ""
          ./pooltype.exe --version || echo "pooltype"
          echo ""
          ./mpost.exe --version || echo "mpost"
          echo ""
          ./pmpost.exe --version || echo "pmpost"
          echo ""
          ./upmpost.exe --version || echo "upmpost"
          echo ""
          ./synctex.exe help || echo "synctex"
        env:
          TEXMFCNF: "../../../texk/kpathsea"

      - name: web2c check
        shell: msys2 {0}
        run: |
          cd ./source/Work/texk/web2c
          $srcdir/ctiedir/ctie.test
          echo ""
          $srcdir/cwebdir/ctwill.test
          echo ""
          $srcdir/cwebdir/cweave.test
          echo ""
          $srcdir/tiedir/tie.test
          echo ""
          $srcdir/tangle.test
          echo ""
          $srcdir/bibtex.test
          echo ""

          export KPSEWHICH="../kpathsea/kpsewhich.exe"
          $srcdir/dvicopy.test
          echo ""
          $srcdir/dvitype.test
          echo ""

          $srcdir/gftodvi.test
          echo ""
          $srcdir/gftopk.test
          echo ""
          $srcdir/gftype.test
          echo ""
          $srcdir/mft.test
          echo ""
          $srcdir/patgen.test
          echo ""
          $srcdir/pktogf.test
          echo ""
          $srcdir/pktype.test
          echo ""
          $srcdir/pltotf.test
          echo ""
          $srcdir/pooltype.test
          echo ""
          $srcdir/tftopl.test
          echo ""
          $srcdir/vftovp.test
          echo ""
          $srcdir/vptovf.test
          echo ""
          $srcdir/weave.test
          echo ""
          $srcdir/twill.test
          echo ""

          $srcdir/etexdir/wprob.test
          echo ""
          $srcdir/ptexdir/pver.test
          echo ""
          $srcdir/eptexdir/epver.test
          echo ""
          $srcdir/uptexdir/upver.test
          echo ""
          $srcdir/uptexdir/upkcat.test
          echo ""
          $srcdir/euptexdir/eupver.test
          echo ""
          $srcdir/uptexdir/sample.test  || \
            { if [ "$?" = "77" ]; then echo "** SKIP: sample.test\n" ; else echo -e "**\n** failed: sample.test\n**" ; fi }
          echo ""
          $srcdir/uptexdir/updvitype.test
          echo ""
          $srcdir/uptexdir/uppltotf.test
          echo ""
          $srcdir/uptexdir/uptftopl.test
          echo ""
          $srcdir/uptexdir/yokotate.test
          echo ""
          $srcdir/uptexdir/upbibtex.test
          echo ""
          # $srcdir/uptexdir/upbibtex-mem.test  || echo -e "**\n** failed: upbibtex-mem.test\n**"
          # echo ""
          export abs_srcdir=../$srcdir
          export LN_S=cp
          export DIFF=diff
          export DIFFFLAGS="--strip-trailing-cr --ignore-matching-lines 'DVItype'"
          # $srcdir/mftraptest.test            || echo -e "**\n** failed: mftraptest.test\n**"
          # echo ""
          $srcdir/triptest.test
          echo ""
          $srcdir/etexdir/etriptest.test
          echo ""
          $srcdir/eptexdir/pdfprimitive.test
          echo ""
          $srcdir/ptexdir/ptriptest.test
          echo ""
          $srcdir/uptexdir/ptriptest.test
          echo ""
          $srcdir/uptexdir/ptriptest.test
          echo ""
          $srcdir/uptexdir/uptriptest.test
          echo ""
          $srcdir/eptexdir/eptriptest.test
          echo ""
          $srcdir/euptexdir/euptriptest.test
          echo ""
          $srcdir/tests/write18-quote-test.pl
          echo ""
          $srcdir/tests/tex-closeout.test
          echo ""
          $srcdir/tests/bibtex-openout-test.pl
          echo ""
          $srcdir/tests/bibtex-longline-test.pl
          echo ""
          $srcdir/tests/bibtex-mem.test
          echo ""
          $srcdir/tests/bibtex-bigauth.test
          echo ""
          $srcdir/tests/bibtex-auxinclude.test
          echo ""
          $srcdir/mplibdir/dvitomp.test
          echo ""
          $srcdir/mplibdir/mptraptest.test
          echo ""
          $srcdir/pmpostdir/pmpost.test
          echo ""
          $srcdir/pmpostdir/pmpsamp.test     || \
            { if [ "$?" = "77" ]; then echo "** SKIP: pmpsamp.test\n" ; else echo -e "**\n** failed: pmpsamp.test\n**" ; fi }
          echo ""
          $srcdir/pmpostdir/upmpost.test
          echo ""
          $srcdir/pmpostdir/upmpsamp.test    || \
            { if [ "$?" = "77" ]; then echo "** SKIP: upmpsamp.test\n" ; else echo -e "**\n** failed: upmpsamp.test\n**" ; fi }
          echo ""
          $srcdir/synctexdir/synctex.test
        env:
          srcdir: "../../../texk/web2c"
          TEXMFCNF: "../../../texk/kpathsea"

      - run: echo "⛄ This job's status is ${{ job.status }}."
