name: Build with Cmake & MSVC
run-name: ${{ github.actor }} is building and testing with Cmake & MSVC
on:
  push:
    branches:
      - 'work*'
      - 'build*'
jobs:
  Build-with-cmake-msvc:
    runs-on: windows-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: cmake
        shell: pwsh
        run: |
          New-Item .\Work -ItemType Directory
          cd .\Work
          cmake.exe ..
      - name: prepare headers
        shell: pwsh
        run: |
          cd .\Work
          python3 ..\source\texk\kpathsea\cmake\kpathsea.py .\source\texk\kpathsea\kpathsea.h config.h paths.h absolute.h c-dir.h c-fopen.h c-namemx.h c-pathch.h c-pathmx.h c-stat.h cnf.h concatn.h expand.h getopt.h line.h magstep.h pathsearch.h proginit.h readable.h tex-glyph.h tex-hush.h tex-make.h variable.h version.h
          python3 ..\source\texk\kpathsea\cmake\cnf-to-paths.py ..\source\texk\kpathsea\texmf.cnf .\source\texk\kpathsea\paths.h
          # type .\source\texk\kpathsea\kpathsea.h
          # type .\source\texk\kpathsea\paths.h
      - name: cmake --build
        shell: pwsh
        run: |
          cd .\Work
          cmake.exe --build .
      - name: test kpathsea
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/kpathsea
          $srcdir/tests/kpsewhich.test
          $srcdir/tests/kpsestat.test
          $srcdir/tests/cnfline.test
          $srcdir/tests/cnfnewline.test
          $srcdir/tests/cnfprog.test
          # $srcdir/tests/kpseaccess.test
          # $srcdir/tests/kpsereadlink.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test makejvf
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/makejvf
          $srcdir/makejvf.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test mendex
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/mendexk
          $srcdir/tests/mendex.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test bibtex-x
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/bibtex-x
          $srcdir/tests/bibtex8.test
          # $srcdir/tests/bibtex8-char.test
          # $srcdir/tests/bibtex8-sort.test
          $srcdir/tests/bibtexu.test
          # $srcdir/tests/bibtexu-basic.test
          # $srcdir/tests/bibtexu-range.test
          # $srcdir/tests/bibtexu-char.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
#      - name: test bibtex-x, max_print_line=99
#        shell: bash
#        run: |
#          cd ./Work
#          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/bibtex-x
#          $srcdir/tests/bibtexu-sort.test
#        env:
#          srcroot: "../source"
#          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
#          max_print_line: "99"
      - name: test dviout-util
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/dviout-util
          $srcdir/dvispc.test
          $srcdir/chkdvifont.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test dvi2tty
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/dvi2tty DVI2TTY_TREE=dvi2tty-src
          $srcdir/disdvi.test
          $srcdir/dvi2tty.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test seetex
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/seetexk
          $srcdir/seetexk.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - name: test dvidvi
        shell: bash
        run: |
          cd ./Work
          export bindir=./Debug/bin exeext=.exe srcdir=../source/texk/dvidvi
          $srcdir/dvidvi.test
        env:
          srcroot: "../source"
          TEXMFCNF: "../source/texk/kpathsea/tests/windows"
      - run: echo "‚õÑ This job's status is ${{ job.status }}."
